<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>GunDB Notes</title>
  <script type="module" crossorigin src="https://cdn.jsdelivr.net/npm/vue@3/dist/vue.esm-browser.js"></script>
  <script type="module" crossorigin src="https://cdn.jsdelivr.net/npm/vuetify@3/dist/vuetify.esm.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/vuetify@3/dist/vuetify.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@mdi/font/css/materialdesignicons.css">
  <script src="https://cdn.jsdelivr.net/npm/gun/gun.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/gun/sea.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/gun/lib/radix.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/gun/lib/radisk.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/gun/lib/store.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/gun/lib/rindexed.js"></script>
</head>
<body>
  <div id="app"></div>

  <script>
    const { createApp, reactive } = Vue
    const { createVuetify } = Vuetify

    // Initialize GunDB
    const gun = Gun({
      peers: ['https://gun-manhattan.herokuapp.com/gun'],
      store: Gun.Store({})
    })
    const user = gun.user()

    // Main App Component
    const App = {
      setup() {
        const state = reactive({
          page: 'login', // Current page: login, register, notes
          username: '',
          password: '',
          newPassword: '',
          note: '',
          loggedInUser: null,
          message: '',
        })

        // Methods
        const register = () => {
          user.create(state.username, state.password, ack => {
            if (ack.err) {
              state.message = `Error: ${ack.err}`
            } else {
              state.message = 'Registration successful! Please login.'
              state.page = 'login'
            }
          })
        }

        const login = () => {
          user.auth(state.username, state.password, ack => {
            if (ack.err) {
              state.message = `Error: ${ack.err}`
            } else {
              state.message = `Welcome, ${state.username}!`
              state.page = 'notes'
              loadNote()
            }
          })
        }

        const changePassword = () => {
          user.auth(state.username, state.password, ack => {
            if (ack.err) {
              state.message = `Error: ${ack.err}`
            } else {
              user.get('alias').secret(state.newPassword, newSecret => {
                user.get('pub').secret(newSecret, ack => {
                  if (ack.err) {
                    state.message = `Error: ${ack.err}`
                  } else {
                    state.message = 'Password changed successfully!'
                  }
                })
              })
            }
          })
        }

        const saveNote = () => {
          user.get('note').put(state.note, ack => {
            if (ack.err) {
              state.message = `Error: ${ack.err}`
            } else {
              state.message = 'Note saved!'
            }
          })
        }

        const loadNote = () => {
          user.get('note').on(data => {
            state.note = data || ''
          })
        }

        const logout = () => {
          user.leave()
          state.page = 'login'
          state.username = ''
          state.password = ''
          state.note = ''
          state.message = 'Logged out!'
        }

        return {
          state,
          register,
          login,
          changePassword,
          saveNote,
          loadNote,
          logout,
        }
      },
      template: `
        <v-app>
          <v-main>
            <v-container>
              <v-alert v-if="state.message" type="info" dismissible>{{ state.message }}</v-alert>

              <!-- Login Page -->
              <div v-if="state.page === 'login'">
                <h2>Login</h2>
                <v-text-field label="Username" v-model="state.username"></v-text-field>
                <v-text-field label="Password" v-model="state.password" type="password"></v-text-field>
                <v-btn color="primary" @click="login">Login</v-btn>
                <v-btn @click="state.page = 'register'">Register</v-btn>
              </div>

              <!-- Register Page -->
              <div v-if="state.page === 'register'">
                <h2>Register</h2>
                <v-text-field label="Username" v-model="state.username"></v-text-field>
                <v-text-field label="Password" v-model="state.password" type="password"></v-text-field>
                <v-btn color="primary" @click="register">Register</v-btn>
                <v-btn @click="state.page = 'login'">Back to Login</v-btn>
              </div>

              <!-- Notes Page -->
              <div v-if="state.page === 'notes'">
                <h2>Welcome, {{ state.username }}</h2>
                <v-textarea label="Your Note" v-model="state.note"></v-textarea>
                <v-btn color="primary" @click="saveNote">Save Note</v-btn>
                <v-btn color="secondary" @click="logout">Logout</v-btn>
                <v-divider></v-divider>
                <h3>Change Password</h3>
                <v-text-field label="Current Password" v-model="state.password" type="password"></v-text-field>
                <v-text-field label="New Password" v-model="state.newPassword" type="password"></v-text-field>
                <v-btn color="error" @click="changePassword">Change Password</v-btn>
              </div>
            </v-container>
          </v-main>
        </v-app>
      `
    }

    const vuetify = createVuetify()
    createApp(App).use(vuetify).mount('#app')
  </script>
</body>
</html>
